@page "{handler?}"
@model RiseDiary.WebUI.Pages.RecordViewModel
@using RiseDiary.Model
@{
    ViewData["Title"] = "Просмотр записи";
    ViewData["TitlePart"] = Model.Record.Date.ToString("yyyy.MM.dd") + " (" + Model.Record.Name + ")";
}

@section Styles{
    <link href="~/lib/summernote/summernote.css" rel="stylesheet" />
    <style>
        .edit-text-area {
        }

        .btn-edit {
        }

        .record-head {
            background-color: #fff8dc;
            text-align: center;
        }

        .record-body {
            background-color: #e4ffdc;
        }

        .record-images {
            background-color: #d4ffee;
            text-align: center;
        }

        .record-cogitations {
            background-color: #e5e5ff;
        }

        .thumbnail-head {
            height: 60px;
        }

        .thumbnail-image {
            height: 160px;
        }

        .center-text {
            text-align: center;
        }
    </style>
}

<input type="hidden" name="recordId" id="recordId" value="@Model.RecordId" />
<table class="table table-condensed">
    <tbody>
        <tr class="record-head">
            <td colspan="4">
                <h4>
                    <b>@Model.Record.Date.ToString("yyyy.MM.dd")</b>&nbsp;:&nbsp;@Model.Record.GetRecordNameDisplay()
                    <component type="typeof(SetStartRecordComponent)" render-mode="ServerPrerendered" param-RecordId="@Model.RecordId" />
                </h4>
            </td>
        </tr>
        <tr class="record-head">
            <td colspan="4" style="vertical-align:middle">
                <h5>Дата создания: <b>@Model.Record.CreateDate.ToString("yyyy.MM.dd HH:mm:ss")</b>&nbsp;&nbsp;&nbsp;&nbsp;Дата редактирования: <b>@Model.Record.ModifyDate.ToString("yyyy.MM.dd HH:mm:ss")</b></h5>
            </td>
        </tr>
        <tr class="record-head">
            <td colspan="4">
                @if (Model.RecordThemes.Count() > 0)
                {
                    <h5>
                        @Model.RecordThemes.First()
                        @for (int i = 1; i < Model.RecordThemes.Count(); i++)
                        {
                            @:| @Model.RecordThemes.ElementAt(i)
                        }
                    </h5>
                }
            </td>
        </tr>
        <tr class="record-body">
            <td colspan="4">
                <div style="padding:5px; font-size:larger">
                    @Html.Raw(Model.Record.Text)
                </div>
            </td>
        </tr>
        <tr class="record-body">
            <td colspan="4">
                <a href="~/Records/Edit?recordId=@Model.RecordId" class="btn btn-info btn-sm">Открыть на редактирование</a>
            </td>
        </tr>
    </tbody>
</table>

<div class="row">
    <div class="col-sm-12">
        @foreach (var image in Model.RecordImages)
        {
            <div id="@("fullImage-" + image.ImageId)" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="imageModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-body">
                            <img src="/api/v1.0/image-file/@image.ImageId" class="img-responsive" style="height:90vh;max-height:100%;margin:auto">
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-3 center-text">
                <div class="panel panel-default">
                    <div class="panel-heading thumbnail-head" style="word-wrap:break-word">
                        <a asp-page="/Images/Edit" asp-route-recordId="@Model.RecordId" asp-route-imageId="@image.ImageId">@image.ImageName</a>
                    </div>

                    <div class="panel-body">
                        <a data-toggle="modal" data-target="@("#fullImage-" + image.ImageId)" style="cursor:pointer">
                            <img src="/api/v1.0/image-thumbnail/@image.ImageId" class="img-thumbnail center-block thumbnail-image" />
                        </a>
                    </div>

                    <div class="panel-footer">
                        <form method="post" asp-page-handler="DeleteImage">
                            <input type="hidden" name="imageId" value="@image.ImageId" />
                            <input type="hidden" name="recordId" value="@Model.RecordId" />
                            <input type="submit" class="btn btn-default btn-sm" value="Открепить" />
                        </form>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<table class="table">
    <tbody>
        <tr>
            <td>
                <a asp-page="/Images/SelectImages" asp-route-recordId="@Model.RecordId" class="btn btn-info btn-sm">Прикрепить изображение</a>
                &nbsp;&nbsp;
                <a asp-page="/images/upload" asp-route-targetRecordId="@Model.RecordId" class="btn btn-info btn-sm">Загрузить и прикрепить изображение</a>
            </td>
            <td></td>
        </tr>
    </tbody>
</table>


<table class="table">
    <tbody>
        <tr class="record-cogitations">
            <td colspan="4"><h3>Мысли по поводу записи, дополнения, выводы:</h3></td>
        </tr>
        @foreach (var cog in Model.Cogitations)
        {
            <tr class="record-cogitations">
                <td colspan="4">
                    <p><b>@cog.Date.ToString("yyyy.MM.dd HH:mm:ss")</b></p>
                    <form asp-page-handler="SaveCogitation" method="post">
                        <input type="hidden" name="cogitationId" value="@cog.Id" />
                        <input type="hidden" name="recordId" value="@cog.RecordId" />
                        <div id="view-cog-@cog.Id" style="padding:10px; font-size:larger">
                            @Html.Raw(cog.Text)
                        </div>
                        <textarea id="edit-cog-@cog.Id" name="cogText" rows="7" class="form-control" style="display:none">@cog.Text</textarea>
                        <p style="float:left; margin-right:10px;">
                            <button type="button" class="btn btn-info btn-sm btn-edit" data-btn-save-id="save-@cog.Id" data-edit-form-id="edit-cog-@cog.Id" data-view-form-id="view-cog-@cog.Id">
                                Редактировать
                            </button>
                            <button type="submit" id="save-@cog.Id" class="btn btn-success btn-sm" style="display:none">
                                Сохранить
                            </button>
                        </p>
                    </form>
                    <form asp-page-handler="DeleteCogitation" method="post">
                        <p>
                            <input type="hidden" name="cogitationId" value="@cog.Id" />
                            <input type="hidden" name="recordId" value="@cog.RecordId" />
                            <button type="submit" class="btn btn-danger btn-sm"
                                    onclick="if (confirm('Удалить осмысдение (комментарий)?')) { return true; } else { return false; }">
                                Удалить
                            </button>
                        </p>
                    </form>
                </td>
            </tr>
        }
        <tr class="record-cogitations">
            <td colspan="4">
                <form asp-page-handler="AddCogitation" method="post">
                    <input type="hidden" name="recordId" value="@Model.RecordId" />
                    <textarea id="newCogText" name="newCogText" class="form-control edit-text-area"></textarea>
                    <button type="submit" class="btn btn-success btn-sm">Добавить</button>
                </form>
            </td>
        </tr>
    </tbody>
</table>

@section Scripts {
    <script src="~/lib/summernote/summernote.js"></script>
    <script type="text/javascript">

        $(function () {
            $('.edit-text-area').summernote({
                height: 250,
                focus: false
            });
            $(document).on('click', '.btn-edit', function () {
                let vid = '#' + $(this).data('view-form-id'); console.log(vid);
                let eid = '#' + $(this).data('edit-form-id'); console.log(eid);
                let bid = '#' + $(this).data('btn-save-id'); console.log(bid);
                $(eid).removeAttr('style'); // у инлайновых стилей приоритет выше. JQuery show() не сработает
                $(bid).removeAttr('style');
                $(vid).hide();
                $(this).hide();
                $(eid).summernote({
                    height: 250,
                    focus: true
                });
            });
        });

    </script>
}
